syntax = "proto3";
package engine.v1;

service Engine {
  rpc Health(HealthRequest) returns (HealthResponse);
  rpc SubmitOrder(SubmitOrderRequest) returns (SubmitOrderResponse);
  rpc GetTopOfBook(GetTopOfBookRequest) returns (GetTopOfBookResponse);
  rpc GetBookDepth(GetBookDepthRequest) returns (GetBookDepthResponse);

  // NEW: Pull-based trade stream (polling)
  rpc GetRecentTrades(GetRecentTradesRequest) returns (GetRecentTradesResponse);
}

message HealthRequest {}
message HealthResponse { string status = 1; }

enum Side {
  SIDE_UNSPECIFIED = 0;
  BUY = 1;
  SELL = 2;
}

message SubmitOrderRequest {
  string symbol = 1;
  Side side = 2;
  int64 price = 3;
  int64 qty = 4;
  string client_order_id = 5;
}

/// One execution generated by matching.
/// maker_seq = resting order sequence
/// taker_seq = incoming order sequence (accepted_seq)
message Fill {
  uint64 maker_seq = 1;
  uint64 taker_seq = 2;
  int64 price = 3;
  int64 qty = 4;
}

message SubmitOrderResponse {
  uint64 accepted_seq = 1;
  repeated Fill fills = 2; // empty if no match
}

message GetTopOfBookRequest {
  string symbol = 1;
}

message GetTopOfBookResponse {
  int64 best_bid_price = 1;
  int64 best_bid_qty = 2;
  int64 best_ask_price = 3;
  int64 best_ask_qty = 4;
}

// ---------- Book Depth (L2) ----------

message PriceLevel {
  int64 price = 1;
  int64 qty = 2;
}

message GetBookDepthRequest {
  string symbol = 1;
  int32 levels = 2;
}

message GetBookDepthResponse {
  repeated PriceLevel bids = 1;
  repeated PriceLevel asks = 2;
}

// ---------- Trades (Tape) ----------

message Trade {
  uint64 trade_id = 1;   // engine-monotonic, deterministic
  string symbol = 2;
  int64 price = 3;
  int64 qty = 4;
  uint64 maker_seq = 5;
  uint64 taker_seq = 6;
  Side taker_side = 7;   // BUY or SELL (who initiated)
}

message GetRecentTradesRequest {
  string symbol = 1;
  uint64 after_trade_id = 2; // return trades with trade_id > this
  int32 limit = 3;           // max trades to return (server caps)
}

message GetRecentTradesResponse {
  repeated Trade trades = 1;
  uint64 last_trade_id = 2;  // max trade_id in response, or echo after_trade_id if none
}
